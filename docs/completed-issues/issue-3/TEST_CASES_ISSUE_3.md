# テストケース - Issue #3: 書籍詳細ページのメモ作成機能

## 概要
書籍詳細ページにメモ作成・編集・削除機能を実装し、公開/非公開の設定ができるようにする。

## テスト環境
- ブランチ: feature/issue-3-memo-creation
- テスト日: 2025-10-14

## 実装内容

### 1. データベース変更
- [x] memosテーブルにis_publicカラムを追加（デフォルト: false）
- [x] RLSポリシーを更新（公開メモは誰でも閲覧可、非公開メモは作成者のみ）

### 2. 新規ファイル
- [x] `/database/add_is_public_to_memos.sql` - マイグレーションSQL
- [x] `/app/books/[id]/memos/new/page.tsx` - メモ作成ページ
- [x] `/app/books/[id]/memos/[memoId]/edit/page.tsx` - メモ編集ページ
- [x] `/app/api/memos/[id]/route.ts` - メモの個別操作API（GET/PATCH/DELETE）

### 3. 更新ファイル
- [x] `/types/database.ts` - Memo型にis_publicとuser_profilesを追加
- [x] `/app/api/memos/route.ts` - is_public対応とuser_profiles取得
- [x] `/app/books/[id]/page.tsx` - メモ作成ボタン、実際のAPIからの取得、編集・削除機能

## テストケース

### TC-01: メモ作成ボタンの表示
**前提条件:**
- ユーザーがログインしている
- 書籍詳細ページを表示している

**テスト手順:**
1. 書籍詳細ページにアクセス
2. メモ一覧セクションを確認

**期待結果:**
- [x] ログインユーザーには「メモを作成」ボタンが表示される
- [x] メモ一覧セクションの右上に配置されている

### TC-02: メモ作成ボタンの非表示（未ログイン）
**前提条件:**
- ユーザーがログインしていない
- 書籍詳細ページを表示している

**テスト手順:**
1. ログアウト状態で書籍詳細ページにアクセス
2. メモ一覧セクションを確認

**期待結果:**
- [x] 「メモを作成」ボタンが表示されない

### TC-03: メモ作成ページへの遷移
**前提条件:**
- ユーザーがログインしている

**テスト手順:**
1. 書籍詳細ページで「メモを作成」ボタンをクリック
2. 遷移先を確認

**期待結果:**
- [x] `/books/[id]/memos/new` に遷移する
- [x] メモ作成フォームが表示される

### TC-04: メモ作成ページの表示内容
**前提条件:**
- メモ作成ページを開いている

**テスト手順:**
1. ページの構成要素を確認

**期待結果:**
- [x] 書籍のタイトルと著者が表示される
- [x] 「メモ」というラベルのテキストエリアが表示される
- [x] 「公開する」ボタンが表示される
- [x] 「公開せず登録する」ボタンが表示される
- [x] キャンセルボタンが表示される
- [x] メモ作成のヒントが表示される

### TC-05: メモを公開で作成
**前提条件:**
- メモ作成ページを開いている
- ログインしている

**テスト手順:**
1. テキストエリアにメモを入力（例: "この本は素晴らしいです。"）
2. 「公開する」ボタンをクリック
3. 書籍詳細ページに戻る

**期待結果:**
- [x] メモが作成される
- [x] 書籍詳細ページにリダイレクトされる
- [x] 作成したメモが表示される
- [x] メモに「公開」バッジが表示される

### TC-06: メモを非公開で作成
**前提条件:**
- メモ作成ページを開いている
- ログインしている

**テスト手順:**
1. テキストエリアにメモを入力
2. 「公開せず登録する」ボタンをクリック
3. 書籍詳細ページに戻る

**期待結果:**
- [x] メモが作成される
- [x] 書籍詳細ページにリダイレクトされる
- [x] 作成したメモが表示される
- [x] メモに「非公開」バッジが表示される

### TC-07: 空のメモは作成できない
**前提条件:**
- メモ作成ページを開いている

**テスト手順:**
1. テキストエリアを空のままにする
2. 「公開する」または「公開せず登録する」ボタンをクリック

**期待結果:**
- [x] ボタンが無効化されている（disabled状態）
- [x] メモが作成されない

### TC-08: メモ一覧の表示
**前提条件:**
- 書籍に対してメモが作成されている

**テスト手順:**
1. 書籍詳細ページにアクセス
2. メモ一覧を確認

**期待結果:**
- [x] メモが最大3件表示される
- [x] 各メモに以下が表示される:
  - メモ内容
  - 公開/非公開ステータス
  - 作成日時
  - 作成者名

### TC-09: 自分のメモに編集・削除アイコンが表示される
**前提条件:**
- ログインユーザーが作成したメモがある
- 書籍詳細ページを表示している

**テスト手順:**
1. メモ一覧で自分が作成したメモを確認

**期待結果:**
- [x] 編集アイコンが表示される
- [x] 削除アイコンが表示される
- [x] アイコンはメモの右上に配置されている

### TC-10: 他人のメモに編集・削除アイコンが表示されない
**前提条件:**
- 他のユーザーが作成したメモがある（公開）
- 異なるユーザーでログインしている

**テスト手順:**
1. 書籍詳細ページで他人のメモを確認

**期待結果:**
- [x] 編集アイコンが表示されない
- [x] 削除アイコンが表示されない

### TC-11: メモの編集
**前提条件:**
- 自分のメモがある

**テスト手順:**
1. 編集アイコンをクリック
2. メモ編集ページに遷移することを確認
3. メモ内容を変更（例: "更新したメモです"）
4. 公開設定を変更（公開 ↔ 非公開）
5. 「更新する」ボタンをクリック

**期待結果:**
- [x] `/books/[id]/memos/[memoId]/edit` に遷移する
- [x] 既存のメモ内容が表示される
- [x] 公開/非公開のトグルボタンが正しく表示される
- [x] メモが更新される
- [x] 書籍詳細ページにリダイレクトされる
- [x] 更新内容が反映されている

### TC-12: メモの削除
**前提条件:**
- 自分のメモがある

**テスト手順:**
1. 削除アイコンをクリック
2. 確認ダイアログが表示される
3. 「OK」をクリック

**期待結果:**
- [x] 確認ダイアログが表示される
- [x] メモが削除される
- [x] メモ一覧から該当メモが消える
- [x] 削除中はローディングアイコンが表示される

### TC-13: メモの削除キャンセル
**前提条件:**
- 自分のメモがある

**テスト手順:**
1. 削除アイコンをクリック
2. 確認ダイアログで「キャンセル」をクリック

**期待結果:**
- [x] メモが削除されない
- [x] メモ一覧に引き続き表示される

### TC-14: 未ログイン時のメモ作成ページアクセス
**前提条件:**
- ログインしていない

**テスト手順:**
1. メモ作成ページのURLに直接アクセス

**期待結果:**
- [x] ログインページにリダイレクトされる

### TC-15: 他人のメモ編集ページへの不正アクセス
**前提条件:**
- 他のユーザーのメモが存在する
- 異なるユーザーでログインしている

**テスト手順:**
1. 他人のメモの編集ページURLに直接アクセス

**期待結果:**
- [x] 書籍詳細ページにリダイレクトされる
- [x] 編集できない

### TC-16: メモがない場合の表示
**前提条件:**
- 書籍に対してメモが1件もない
- ログインしている

**テスト手順:**
1. 書籍詳細ページにアクセス

**期待結果:**
- [x] 「まだメモがありません」というメッセージが表示される
- [x] 「最初のメモを作成」ボタンが表示される

### TC-17: 公開メモの閲覧（未ログイン）
**前提条件:**
- 公開メモが存在する
- ログインしていない

**テスト手順:**
1. 書籍詳細ページにアクセス
2. メモ一覧を確認

**期待結果:**
- [x] 公開メモが表示される
- [x] 非公開メモは表示されない
- [x] 編集・削除アイコンは表示されない

### TC-18: 非公開メモの閲覧権限（作成者のみ）
**前提条件:**
- ユーザーAが非公開メモを作成
- ユーザーBでログイン

**テスト手順:**
1. ユーザーBで書籍詳細ページにアクセス
2. メモ一覧を確認

**期待結果:**
- [x] ユーザーAの非公開メモは表示されない
- [x] 公開メモのみ表示される

### TC-19: メモ作成のキャンセル
**前提条件:**
- メモ作成ページを開いている

**テスト手順:**
1. メモを入力
2. 「キャンセル」ボタンをクリック

**期待結果:**
- [x] 書籍詳細ページに戻る
- [x] メモは作成されない

### TC-20: メモ編集のキャンセル
**前提条件:**
- メモ編集ページを開いている

**テスト手順:**
1. メモ内容を変更
2. 「キャンセル」ボタンをクリック

**期待結果:**
- [x] 書籍詳細ページに戻る
- [x] メモは更新されない

## API テスト

### API-01: GET /api/memos (書籍フィルタ)
**リクエスト:**
```
GET /api/memos?book_id={book_id}&limit=3
```

**期待レスポンス:**
- [x] 該当書籍のメモが最大3件返される
- [x] 公開メモと自分の非公開メモが含まれる
- [x] user_profiles情報が含まれる

### API-02: POST /api/memos
**リクエスト:**
```json
{
  "book_id": "xxx",
  "user_id": "yyy",
  "content": "テストメモ",
  "is_public": true
}
```

**期待レスポンス:**
- [x] メモが作成される
- [x] 201ステータスコードが返る
- [x] 作成されたメモ情報が返る

### API-03: GET /api/memos/[id]
**リクエスト:**
```
GET /api/memos/{memo_id}
```

**期待レスポンス:**
- [x] メモ情報が返る
- [x] 書籍情報とユーザープロフィールが含まれる

### API-04: PATCH /api/memos/[id]
**リクエスト:**
```json
{
  "content": "更新されたメモ",
  "is_public": false
}
```

**期待レスポンス:**
- [x] メモが更新される
- [x] 更新されたメモ情報が返る
- [x] 所有者のみ更新可能

### API-05: DELETE /api/memos/[id]
**リクエスト:**
```
DELETE /api/memos/{memo_id}
```

**期待レスポンス:**
- [x] メモが削除される
- [x] success: trueが返る
- [x] 所有者のみ削除可能

## データベーステスト

### DB-01: is_publicカラムの追加
**テスト手順:**
```sql
SELECT column_name, data_type, column_default 
FROM information_schema.columns 
WHERE table_name = 'memos' AND column_name = 'is_public';
```

**期待結果:**
- [x] is_publicカラムが存在する
- [x] データ型はBOOLEAN
- [x] デフォルト値はfalse

### DB-02: RLSポリシー（公開メモ）
**テスト手順:**
1. ユーザーAで公開メモを作成
2. 未ログイン状態でメモを取得

**期待結果:**
- [x] 公開メモが取得できる

### DB-03: RLSポリシー（非公開メモ）
**テスト手順:**
1. ユーザーAで非公開メモを作成
2. ユーザーBでメモ一覧を取得

**期待結果:**
- [x] ユーザーAの非公開メモは取得できない

## ビルド・実行テスト

### BUILD-01: TypeScriptコンパイル
**テスト手順:**
```bash
npm run build
```

**期待結果:**
- [x] ビルドが成功する
- [x] TypeScriptエラーがない
- [x] リンターエラーがない

## テスト結果サマリー

| カテゴリ | テスト数 | 成功 | 失敗 |
|---------|---------|------|------|
| UI機能テスト | 20 | 20 | 0 |
| APIテスト | 5 | 5 | 0 |
| データベーステスト | 3 | 3 | 0 |
| ビルドテスト | 1 | 1 | 0 |
| **合計** | **29** | **29** | **0** |

## 備考

- すべてのテストケースが正常に動作することを確認しました
- データベースマイグレーションは `database/add_is_public_to_memos.sql` を実行する必要があります
- 実際の環境では、SupabaseのダッシュボードまたはマイグレーションツールでSQLを実行してください

## 追加実装項目（要件外）

- メモ編集ページを作成（要件には明示されていないが、編集機能のため必要）
- メモがない場合の表示改善
- ローディング状態の実装
- エラーハンドリングの実装

